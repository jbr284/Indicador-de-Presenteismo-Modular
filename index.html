<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular | Sistema de Gestão</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary: #2563eb; --primary-dark: #1d4ed8; --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #334155; --text-light: #64748b; --border: #e2e8f0; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        * { box-sizing: border-box; } body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ESTILOS NORMAIS (TELA) */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--card-bg); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .auth-box h2 { color: var(--sidebar-bg); margin-bottom: 1.5rem; font-weight: 700; }
        #app-container { display: flex; width: 100%; height: 100%; }
        aside { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; border-right: 1px solid #1e293b; flex-shrink: 0; transition: transform 0.3s; }
        .brand { color: white; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2.5rem; padding-left: 0.5rem; cursor: pointer; user-select: none; }
        .brand i { color: var(--primary); font-size: 1.5rem; }
        nav button { background: transparent; border: none; color: var(--sidebar-text); width: 100%; padding: 0.85rem 1rem; text-align: left; cursor: pointer; border-radius: 8px; font-family: inherit; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 0.75rem; transition: all 0.2s; margin-bottom: 0.5rem; }
        nav button:hover { background: rgba(255,255,255,0.05); color: white; }
        nav button.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .user-profile { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-radius: 8px; padding: 10px; cursor: pointer; }
        .user-profile:hover { background: rgba(255,255,255,0.05); }
        .avatar-container { width: 40px; height: 40px; border-radius: 50%; background: #334155; overflow: hidden; flex-shrink: 0; border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-placeholder { color: white; font-weight: bold; font-size: 1.2rem; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .user-role { font-size: 0.75rem; color: var(--sidebar-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-logout { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 0.5rem; border-radius: 6px; }
        .btn-logout:hover { background: rgba(239, 68, 68, 0.1); }
        .content-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { background: var(--card-bg); height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; }
        header h1 { font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin: 0; }
        .header-date { font-size: 0.85rem; color: var(--text-light); font-weight: 500; background: var(--bg); padding: 0.4rem 0.8rem; border-radius: 20px; }
        main { flex: 1; overflow-y: auto; padding: 2rem; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .card h3 { margin-top: 0; font-size: 1rem; color: var(--text-main); font-weight: 600; margin-bottom: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 0.8rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.2rem; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--text-main); }
        input, select { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: 'Inter'; font-size: 0.9rem; transition: border-color 0.2s; background: #fff; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { filter: brightness(0.9); transform: translateY(-1px); }
        .btn-edit { background: var(--warning); color: white; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .btn-edit:hover { filter: brightness(0.9); transform: translateY(-1px); }
        .btn-print { background: #1e293b; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-print:hover { background: #0f172a; transform: translateY(-1px); }
        
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8fafc; text-align: left; padding: 0.8rem 1rem; font-weight: 600; color: var(--text-light); border-bottom: 1px solid var(--border); }
        td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .status-bad { color: var(--danger); font-weight: 700; background: #fef2f2; padding: 2px 8px; border-radius: 12px; }
        .turn-header { background: #f1f5f9; color: var(--text-main); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .total-row { background: #f8fafc; font-weight: 700; border-top: 2px solid #cbd5e1; }
        .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; }
        .mini-card { background: white; padding: 1.2rem; border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid transparent; transition: transform 0.2s; }
        .mini-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .mini-card .val { font-size: 1.75rem; font-weight: 700; color: var(--text-main); margin-top: 0.5rem; }
        .mini-card .sub-val { font-size: 0.8rem; color: var(--success); font-weight: 600; margin-top: 0.2rem; display: flex; align-items: center; gap: 4px; }
        .border-t1 { border-left-color: #3b82f6; } .border-t2 { border-left-color: #f59e0b; } .border-total { border-left-color: var(--success); } .border-sector { border-left-color: #8b5cf6; } .alert-text { color: var(--danger) !important; }
        .chart-box { height: 400px; padding: 1rem; }

        /* --- CSS DE IMPRESSÃO (Modo Relatório) --- */
        #report-container { display: none; } /* Oculto na tela normal */

        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white; color: black; zoom: 95%; height: auto; overflow: visible; }
            #auth-overlay, #app-container, .swal2-container { display: none !important; } /* Esconde o App */
            
            #report-container { display: block !important; width: 100%; font-family: 'Inter', sans-serif; }
            
            .report-page { 
                width: 100%; height: 180mm; /* Altura segura A4 */ 
                position: relative; 
                page-break-after: always; /* Força nova página */
            }
            .report-page:last-child { page-break-after: auto; }

            .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .rep-logo { font-size: 24px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
            .rep-info { text-align: right; font-size: 12px; }
            .rep-title { font-size: 18px; font-weight: 700; text-transform: uppercase; margin: 20px 0 10px 0; }

            .rep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
            .rep-card { border: 1px solid #ccc; padding: 10px; border-radius: 4px; }
            .rep-card h4 { margin: 0; font-size: 10px; text-transform: uppercase; color: #666; }
            .rep-card .val { font-size: 20px; font-weight: 700; margin: 5px 0; }
            
            /* Ajuste de Tabela para Impressão */
            .rep-table { width: 100%; border-collapse: collapse; font-size: 11px; }
            .rep-table th { background: #eee; border-bottom: 1px solid #000; text-align: left; padding: 5px; -webkit-print-color-adjust: exact; }
            .rep-table td { border-bottom: 1px solid #ccc; padding: 5px; }
            
            .rep-chart-box { width: 100%; height: 400px; border: 1px solid #ddd; padding: 10px; margin-top: 20px; }
        }

        @media (max-width: 768px) { #app-container { flex-direction: column; } aside { width: 100%; height: auto; padding: 1rem; border-right: none; border-bottom: 1px solid #1e293b; flex-direction: row; align-items: center; justify-content: space-between; } .brand { margin-bottom: 0; } nav { display: flex; gap: 0.5rem; } nav button span { display: none; } nav button { width: auto; padding: 0.5rem; margin: 0; } .user-profile { display: none; } header { padding: 0 1rem; } main { padding: 1rem; } }
    </style>
</head>
<body>
    <div id="auth-overlay"><div class="auth-box"><div style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"><i class="ph-fill ph-shield-check"></i></div><h2>Acesso Restrito</h2><div class="form-grid" style="grid-template-columns: 1fr; gap: 1rem; text-align: left;"><div class="input-group"><label>Email Corporativo</label><input type="email" id="login-email" placeholder="nome@modular.com"></div><div class="input-group"><label>Senha</label><input type="password" id="login-pass"></div><button class="btn btn-primary" onclick="app.login()" style="width: 100%; margin-top: 1rem;">ACESSAR SISTEMA</button></div><p id="auth-error" style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; min-height: 20px;"></p></div></div>
    
    <div id="app-container" style="display: none;">
        <aside>
            <div class="brand" onclick="app.secretDebug()"><i class="ph-fill ph-squares-four"></i> MODULAR</div>
            <nav><button class="active" onclick="app.switchTab('tab-lancamento')"><i class="ph ph-note-pencil"></i> <span>Lançamentos</span></button><button onclick="app.switchTab('tab-indicadores')"><i class="ph ph-chart-line-up"></i> <span>Indicadores</span></button></nav>
            <div class="user-profile" onclick="app.openProfileEditor()" title="Clique para editar seu perfil"><div class="avatar-container"><img id="user-avatar-img" src="" style="display: none;"><div id="user-avatar-placeholder" class="avatar-placeholder"><i class="ph ph-user"></i></div></div><div class="user-info"><div class="user-name" id="profile-name">Carregando...</div><div class="user-role" id="profile-role">...</div></div><button class="btn-logout" onclick="event.stopPropagation(); app.logout()" title="Sair"><i class="ph ph-sign-out"></i></button></div>
        </aside>
        <div class="content-wrapper">
            <header><h1>Controle de Absenteísmo</h1><div class="header-date"><i class="ph ph-clock"></i> <span id="current-datetime">--/--/--</span></div></header>
            <main>
                <section id="tab-lancamento" class="view-section active">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; border-bottom:1px solid #e2e8f0; padding-bottom:0.8rem;">
                            <h3 style="border:none; margin:0; padding:0; white-space:nowrap;"><i class="ph ph-file-plus"></i> Novo Registro</h3>
                        </div>
                        <div class="form-grid">
                            <div class="input-group"><label>Planta</label><select id="inp-planta" onchange="app.updateSectors(); app.loadHeadcount()"><option value="">Selecione...</option><option value="PLANTA 3">PLANTA 3</option><option value="PLANTA 4">PLANTA 4</option></select></div>
                            <div class="input-group"><label>Turno</label><select id="inp-turno" onchange="app.loadHeadcount()"><option value="1º TURNO">1º TURNO</option><option value="2º TURNO">2º TURNO</option></select></div>
                            <div class="input-group"><label>Setor</label><select id="inp-setor" onchange="app.loadHeadcount()"><option value="">Selecione...</option></select></div>
                            <div class="input-group"><label>Data</label><input type="date" id="inp-data"></div>
                            <div class="input-group"><label>Efetivo (Auto)</label><input type="number" id="inp-efetivo" min="1" placeholder="..."></div>
                            <div class="input-group"><label>Qtd Faltas</label><input type="number" id="inp-faltas" min="0"></div>
                            <div class="input-group" style="display: flex; align-items: flex-end;">
                                <button id="btn-save" class="btn btn-primary" onclick="app.saveData()" style="width: 100%;"><i class="ph-bold ph-floppy-disk"></i> <span id="btn-save-text">Salvar Registro</span></button>
                                <button id="btn-cancel-edit" class="btn" onclick="app.cancelEdit()" style="display:none; margin-left:10px; background:#e2e8f0; color:#334155;">Cancelar</button>
                            </div>
                        </div>
                    </div>
                    <div class="card"><h3>Histórico - Planta 3</h3><div class="table-container"><table id="table-p3"><thead><tr><th>Data</th><th>Setor/Turno</th><th>Efetivo</th><th>Faltas</th><th>Absenteísmo</th><th style="min-width:100px;">Ações</th></tr></thead><tbody></tbody></table></div></div>
                    <div class="card"><h3>Histórico - Planta 4</h3><div class="table-container"><table id="table-p4"><thead><tr><th>Data</th><th>Setor/Turno</th><th>Efetivo</th><th>Faltas</th><th>Absenteísmo</th><th style="min-width:100px;">Ações</th></tr></thead><tbody></tbody></table></div></div>
                </section>
                <section id="tab-indicadores" class="view-section">
                    <div class="card" style="padding: 1rem;">
                        <div class="form-grid" style="align-items: end; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="input-group"><label>Data Inicial</label><input type="date" id="dash-start"></div>
                            <div class="input-group"><label>Data Final</label><input type="date" id="dash-end"></div>
                            <button class="btn btn-primary" onclick="app.updateDashboard()"><i class="ph-bold ph-funnel"></i> Filtrar Dados</button>
                            <button class="btn btn-print" onclick="app.printReport()"><i class="ph-bold ph-printer"></i> Imprimir Relatório</button>
                        </div>
                    </div>
                    <div class="dash-section-title">Visão Geral (Plantas)</div>
                    <div class="compact-grid">
                        <div class="mini-card border-total"><h4>Planta 3</h4><div class="val" id="kpi-p3">-%</div><span class="sub-val" id="mean-p3">Média: -</span></div>
                        <div class="mini-card border-total"><h4>Planta 4</h4><div class="val" id="kpi-p4">-%</div><span class="sub-val" id="mean-p4">Média: -</span></div>
                        <div class="mini-card border-total" style="background: #eff6ff; border-left-color: #2563eb;"><h4>GLOBAL (MODULAR)</h4><div class="val" id="kpi-global">-%</div><span class="sub-val" id="mean-global">Média: -</span></div>
                    </div>
                    <div class="dash-section-title">Performance por Setor - 1º TURNO</div><div id="grid-t1" class="compact-grid"></div>
                    <div class="dash-section-title">Performance por Setor - 2º TURNO</div><div id="grid-t2" class="compact-grid"></div>
                    <div class="dash-section-title">Consolidado por Setor (Total)</div><div id="grid-consolidado" class="compact-grid"></div>
                    <div class="card chart-box" style="margin-top: 1.5rem;"><canvas id="chart-evolution"></canvas></div>
                </section>
            </main>
        </div>
    </div>

    <div id="report-container">
        <div class="report-page">
            <div class="rep-header">
                <div class="rep-logo"><i class="ph-fill ph-squares-four"></i> MODULAR</div>
                <div class="rep-info">
                    <strong>Relatório Gerencial de Absenteísmo</strong><br>
                    Período: <span id="rep-periodo">--/-- a --/--</span><br>
                    Emissão: <span id="rep-emissao">--/--</span>
                </div>
            </div>

            <div class="rep-title">1. Visão Geral (KPIs)</div>
            <div class="rep-grid">
                <div class="rep-card"><h4>Global</h4><div class="val" id="rep-kpi-global">-%</div></div>
                <div class="rep-card"><h4>Planta 3</h4><div class="val" id="rep-kpi-p3">-%</div></div>
                <div class="rep-card"><h4>Planta 4</h4><div class="val" id="rep-kpi-p4">-%</div></div>
            </div>

            <div class="rep-title">2. Detalhamento por Setor</div>
            <table class="rep-table">
                <thead><tr><th>Setor</th><th>Turno</th><th>Efetivo Total</th><th>Faltas Total</th><th>% Absenteísmo</th></tr></thead>
                <tbody id="rep-table-body"></tbody>
            </table>
        </div>

        <div class="report-page">
            <div class="rep-header">
                <div class="rep-logo"><i class="ph-fill ph-squares-four"></i> MODULAR</div>
                <div class="rep-info">Anexo Gráfico - Pág. 2</div>
            </div>
            
            <div class="rep-title">3. Evolução por Setor (Período Selecionado)</div>
            <div class="rep-chart-box">
                <canvas id="rep-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js')); }
        setInterval(() => { const el = document.getElementById('current-datetime'); if(el) el.innerText = new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }); }, 1000);
    </script>
</body>
</html>
