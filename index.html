<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular | Sistema de Gestão</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --primary: #2563eb; --primary-dark: #1d4ed8; 
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; 
            --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #334155; --text-light: #64748b; 
            --border: #e2e8f0; --success: #10b981; --danger: #ef4444; 
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--card-bg); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        
        /* LAYOUT */
        #app-container { display: flex; width: 100%; height: 100%; }
        aside { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; border-right: 1px solid #1e293b; flex-shrink: 0; }
        
        .brand { color: white; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2.5rem; padding-left: 0.5rem; }
        .brand i { color: var(--primary); font-size: 1.5rem; }
        
        nav button { background: transparent; border: none; color: var(--sidebar-text); width: 100%; padding: 0.85rem 1rem; text-align: left; cursor: pointer; border-radius: 8px; font-family: inherit; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 0.75rem; transition: all 0.2s; margin-bottom: 0.5rem; }
        nav button:hover { background: rgba(255,255,255,0.05); color: white; }
        nav button.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        
        /* PERFIL NA SIDEBAR (NOVO) */
        .user-profile { 
            margin-top: auto; padding-top: 1.5rem; border-top: 1px solid #1e293b; 
            display: flex; align-items: center; gap: 10px; 
        }
        .avatar-container {
            width: 40px; height: 40px; border-radius: 50%; background: #334155; 
            overflow: hidden; flex-shrink: 0; border: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-placeholder { color: white; font-weight: bold; font-size: 1.2rem; }

        .user-info { flex: 1; overflow: hidden; cursor: pointer; }
        .user-name { font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .user-role { font-size: 0.75rem; color: var(--sidebar-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-logout { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 0.5rem; }

        /* CONTEÚDO */
        .content-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--card-bg); height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; }
        main { flex: 1; overflow-y: auto; padding: 2rem; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Componentes */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.2rem; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.4rem; }
        input, select { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: 'Inter'; font-size: 0.9rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* Tabelas e Dashboard */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f8fafc; font-weight: 600; color: var(--text-light); }
        .status-bad { color: var(--danger); background: #fef2f2; padding: 2px 8px; border-radius: 12px; font-weight: 700; }
        .turn-header { background: #f1f5f9; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        
        .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; }
        .mini-card { background: white; padding: 1.2rem; border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid transparent; }
        .mini-card .val { font-size: 1.75rem; font-weight: 700; margin-top: 0.5rem; }
        
        .border-t1 { border-left-color: #3b82f6; }
        .border-t2 { border-left-color: #f59e0b; }
        .border-total { border-left-color: var(--success); }
        .border-sector { border-left-color: #8b5cf6; }
        .alert-text { color: var(--danger) !important; }
        .chart-box { height: 400px; padding: 1rem; }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            aside { width: 100%; flex-direction: row; align-items: center; justify-content: space-between; padding: 1rem; }
            .user-profile { display: none; }
            nav button span { display: none; }
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <div style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"><i class="ph-fill ph-shield-check"></i></div>
            <h2>Acesso Restrito</h2>
            <div class="form-grid" style="grid-template-columns: 1fr; gap: 1rem; text-align: left;">
                <div class="input-group"><label>Email Corporativo</label><input type="email" id="login-email" placeholder="nome@modular.com"></div>
                <div class="input-group"><label>Senha</label><input type="password" id="login-pass"></div>
                <button class="btn btn-primary" onclick="app.login()" style="width: 100%; margin-top: 1rem;">ACESSAR SISTEMA</button>
            </div>
            <p id="auth-error" style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; min-height: 20px;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <aside>
            <div class="brand"><i class="ph-fill ph-squares-four"></i> MODULAR</div>
            <nav>
                <button class="active" onclick="app.switchTab('tab-lancamento')"><i class="ph ph-note-pencil"></i> <span>Lançamentos</span></button>
                <button onclick="app.switchTab('tab-indicadores')"><i class="ph ph-chart-line-up"></i> <span>Indicadores</span></button>
            </nav>
            
            <div class="user-profile">
                <div class="avatar-container" onclick="app.openProfileEditor()" title="Editar Perfil">
                    <img id="user-avatar-img" src="" style="display: none;">
                    <div id="user-avatar-placeholder" class="avatar-placeholder"><i class="ph ph-user"></i></div>
                </div>
                
                <div class="user-info" onclick="app.openProfileEditor()" title="Editar Perfil">
                    <div class="user-name" id="profile-name">Carregando...</div>
                    <div class="user-role" id="profile-role">...</div>
                </div>
                
                <button class="btn-logout" onclick="app.logout()" title="Sair"><i class="ph ph-sign-out"></i></button>
            </div>
        </aside>

        <div class="content-wrapper">
            <header>
                <h1 style="font-size: 1.1rem; font-weight: 600;">Controle de Absenteísmo</h1>
                <div style="font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 0.4rem 0.8rem; border-radius: 20px;">
                    <i class="ph ph-clock"></i> <span id="current-datetime">--/--/--</span>
                </div>
            </header>

            <main>
                <section id="tab-lancamento" class="view-section active">
                    <div class="card">
                        <h3><i class="ph ph-file-plus"></i> Novo Registro</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>Planta</label><select id="inp-planta" onchange="app.updateSectors(); app.loadHeadcount()"><option value="">Selecione...</option><option value="PLANTA 3">PLANTA 3</option><option value="PLANTA 4">PLANTA 4</option></select></div>
                            <div class="input-group"><label>Turno</label><select id="inp-turno" onchange="app.loadHeadcount()"><option value="1º TURNO">1º TURNO</option><option value="2º TURNO">2º TURNO</option></select></div>
                            <div class="input-group"><label>Setor</label><select id="inp-setor" onchange="app.loadHeadcount()"><option value="">Selecione...</option></select></div>
                            <div class="input-group"><label>Data</label><input type="date" id="inp-data"></div>
                            <div class="input-group"><label>Efetivo (Auto)</label><input type="number" id="inp-efetivo" min="1" placeholder="..."></div>
                            <div class="input-group"><label>Qtd Faltas</label><input type="number" id="inp-faltas" min="0"></div>
                            <div class="input-group" style="display: flex; align-items: flex-end;"><button class="btn btn-primary" onclick="app.saveData()" style="width: 100%;"><i class="ph-bold ph-floppy-disk"></i> Salvar</button></div>
                        </div>
                    </div>
                    <div class="card"><h3>Histórico - Planta 3</h3><div class="table-container"><table id="table-p3"><thead><tr><th>Data</th><th>Setor/Turno</th><th>Efetivo</th><th>Faltas</th><th>Absenteísmo</th><th>Ações</th></tr></thead><tbody></tbody></table></div></div>
                    <div class="card"><h3>Histórico - Planta 4</h3><div class="table-container"><table id="table-p4"><thead><tr><th>Data</th><th>Setor/Turno</th><th>Efetivo</th><th>Faltas</th><th>Absenteísmo</th><th>Ações</th></tr></thead><tbody></tbody></table></div></div>
                </section>

                <section id="tab-indicadores" class="view-section">
                    <div class="card" style="padding: 1rem;">
                        <div class="form-grid" style="align-items: end; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="input-group"><label>Data Inicial</label><input type="date" id="dash-start"></div>
                            <div class="input-group"><label>Data Final</label><input type="date" id="dash-end"></div>
                            <button class="btn btn-primary" onclick="app.updateDashboard()"><i class="ph-bold ph-funnel"></i> Filtrar Dados</button>
                        </div>
                    </div>
                    <div class="dash-section-title">Visão Geral (Plantas)</div>
                    <div class="compact-grid">
                        <div class="mini-card border-total"><h4>Planta 3</h4><div class="val" id="kpi-p3">-%</div><span class="sub-val" id="mean-p3">Média: -</span></div>
                        <div class="mini-card border-total"><h4>Planta 4</h4><div class="val" id="kpi-p4">-%</div><span class="sub-val" id="mean-p4">Média: -</span></div>
                        <div class="mini-card border-total" style="background: #eff6ff; border-left-color: #2563eb;"><h4>GLOBAL (MODULAR)</h4><div class="val" id="kpi-global">-%</div><span class="sub-val" id="mean-global">Média: -</span></div>
                    </div>
                    <div class="dash-section-title">Performance por Setor - 1º TURNO</div><div id="grid-t1" class="compact-grid"></div>
                    <div class="dash-section-title">Performance por Setor - 2º TURNO</div><div id="grid-t2" class="compact-grid"></div>
                    <div class="dash-section-title">Consolidado por Setor (Total)</div><div id="grid-consolidado" class="compact-grid"></div>
                    <div class="card chart-box" style="margin-top: 1.5rem;"><canvas id="chart-evolution"></canvas></div>
                </section>
            </main>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js')); }
        setInterval(() => { const el = document.getElementById('current-datetime'); if(el) el.innerText = new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }); }, 1000);
    </script>
</body>
</html>
